# Segmentation Fault 時のバックトレース取得

セグメンテーションフォールトが発生する場合は libSegFault.so を利用することができる。
実行方法は下記のようになる。

```sh
catchsegv hoge
# or
LD_PRELOAD=/lib/libSegFault.so hoge
```

## 注意点

- ビルド時に `-O2` などをつけると呼び出し履歴が変わる。
- ビルド時に `-rdynamic` をつけないと関数が得られない。

## Usage

サンプルとして用意している実行例は下記のようになる。

```sh
make build

make run-catchsegv  # catchsegv タイプ
# or
make run-preload    # LD_PRELOAD タイプ
```

`LD_PRELOAD` する libSegFault.so に関しては、環境によって場所が異なる可能性がある。

## Example

`catchsegv` を利用した場合の結果例。

```txt
In main
In segFaultFunction_
Segmentation fault
*** Segmentation fault
Register dump:

 RAX: 0000562711a73020   RBX: 0000000000000000   RCX: 0000000000000400
 RDX: 00007f7d7a054960   RSI: 0000000000000000   RDI: 00007fff4b39d640
 RBP: 0000562711872980   R8 : 0000000000000000   R9 : 0000000000000000
 R10: 0000000000000007   R11: 0000000000000246   R12: 0000562711872870
 R13: 00007fff4b39d7a0   R14: 0000000000000000   R15: 0000000000000000
 RSP: 00007fff4b39d6c0

 RIP: 000056271187282a   EFLAGS: 00010202

 CS: 0033   FS: 0000   GS: 0000

 Trap: 0000000e   Error: 00000006   OldMask: 00000000   CR2: 00000000

 FPUCW: 0000037f   FPUSW: 00000000   TAG: 00000000
 RIP: 00000000   RDP: 00000000

 ST(0) 0000 0000000000000000   ST(1) 0000 0000000000000000
 ST(2) 0000 0000000000000000   ST(3) 0000 0000000000000000
 ST(4) 0000 0000000000000000   ST(5) 0000 0000000000000000
 ST(6) 0000 0000000000000000   ST(7) 0000 0000000000000000
 mxcsr: 1f80
 XMM0:  00000000000000000000000000000000 XMM1:  00000000000000000000000000000000
 XMM2:  00000000000000000000000000000000 XMM3:  00000000000000000000000000000000
 XMM4:  00000000000000000000000000000000 XMM5:  00000000000000000000000000000000
 XMM6:  00000000000000000000000000000000 XMM7:  00000000000000000000000000000000
 XMM8:  00000000000000000000000000000000 XMM9:  00000000000000000000000000000000
 XMM10: 00000000000000000000000000000000 XMM11: 00000000000000000000000000000000
 XMM12: 00000000000000000000000000000000 XMM13: 00000000000000000000000000000000
 XMM14: 00000000000000000000000000000000 XMM15: 00000000000000000000000000000000

Backtrace:
../_bin/backtrace_segfault.out(+0x82a)[0x56271187282a]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7f7d79904b97]
../_bin/backtrace_segfault.out(+0x89a)[0x56271187289a]

Memory map:

562711872000-562711873000 r-xp 00000000 00:70 2814749767339388 /workspace/_bin/backtrace_segfault.out
562711a72000-562711a73000 r--p 00000000 00:70 2814749767339388 /workspace/_bin/backtrace_segfault.out
562711a73000-562711a74000 rw-p 00001000 00:70 2814749767339388 /workspace/_bin/backtrace_segfault.out
562712027000-562712048000 rw-p 00000000 00:00 0 [heap]
7f7d7932d000-7f7d79344000 r-xp 00000000 08:01 2885618 /lib/x86_64-linux-gnu/libgcc_s.so.1
7f7d79344000-7f7d79543000 ---p 00017000 08:01 2885618 /lib/x86_64-linux-gnu/libgcc_s.so.1
7f7d79543000-7f7d79544000 r--p 00016000 08:01 2885618 /lib/x86_64-linux-gnu/libgcc_s.so.1
7f7d79544000-7f7d79545000 rw-p 00017000 08:01 2885618 /lib/x86_64-linux-gnu/libgcc_s.so.1
7f7d79545000-7f7d796e2000 r-xp 00000000 08:01 786927 /lib/x86_64-linux-gnu/libm-2.27.so
7f7d796e2000-7f7d798e1000 ---p 0019d000 08:01 786927 /lib/x86_64-linux-gnu/libm-2.27.so
7f7d798e1000-7f7d798e2000 r--p 0019c000 08:01 786927 /lib/x86_64-linux-gnu/libm-2.27.so
7f7d798e2000-7f7d798e3000 rw-p 0019d000 08:01 786927 /lib/x86_64-linux-gnu/libm-2.27.so
7f7d798e3000-7f7d79aca000 r-xp 00000000 08:01 786902 /lib/x86_64-linux-gnu/libc-2.27.so
7f7d79aca000-7f7d79cca000 ---p 001e7000 08:01 786902 /lib/x86_64-linux-gnu/libc-2.27.so
7f7d79cca000-7f7d79cce000 r--p 001e7000 08:01 786902 /lib/x86_64-linux-gnu/libc-2.27.so
7f7d79cce000-7f7d79cd0000 rw-p 001eb000 08:01 786902 /lib/x86_64-linux-gnu/libc-2.27.so
7f7d79cd0000-7f7d79cd4000 rw-p 00000000 00:00 0
7f7d79cd4000-7f7d79e4d000 r-xp 00000000 08:01 2890875 /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.25
7f7d79e4d000-7f7d7a04d000 ---p 00179000 08:01 2890875 /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.25
7f7d7a04d000-7f7d7a057000 r--p 00179000 08:01 2890875 /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.25
7f7d7a057000-7f7d7a059000 rw-p 00183000 08:01 2890875 /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.25
7f7d7a059000-7f7d7a05d000 rw-p 00000000 00:00 0
7f7d7a05d000-7f7d7a061000 r-xp 00000000 08:01 786888 /lib/x86_64-linux-gnu/libSegFault.so
7f7d7a061000-7f7d7a260000 ---p 00004000 08:01 786888 /lib/x86_64-linux-gnu/libSegFault.so
7f7d7a260000-7f7d7a261000 r--p 00003000 08:01 786888 /lib/x86_64-linux-gnu/libSegFault.so
7f7d7a261000-7f7d7a262000 rw-p 00004000 08:01 786888 /lib/x86_64-linux-gnu/libSegFault.so
7f7d7a262000-7f7d7a289000 r-xp 00000000 08:01 786884 /lib/x86_64-linux-gnu/ld-2.27.so
7f7d7a47d000-7f7d7a482000 rw-p 00000000 00:00 0
7f7d7a487000-7f7d7a489000 rw-p 00000000 00:00 0
7f7d7a489000-7f7d7a48a000 r--p 00027000 08:01 786884 /lib/x86_64-linux-gnu/ld-2.27.so
7f7d7a48a000-7f7d7a48b000 rw-p 00028000 08:01 786884 /lib/x86_64-linux-gnu/ld-2.27.so
7f7d7a48b000-7f7d7a48c000 rw-p 00000000 00:00 0
7fff4b37e000-7fff4b39f000 rw-p 00000000 00:00 0 [stack]
7fff4b3a8000-7fff4b3aa000 r--p 00000000 00:00 0 [vvar]
7fff4b3aa000-7fff4b3ac000 r-xp 00000000 00:00 0 [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0 [vsyscall]
```
